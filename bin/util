#!/usr/bin/bash

shopt -s expand_aliases       # expand aliases in non-interactive shell

alias setblock="read -d ''"   # for multi-line text blocks

timestamp() {
  date +"%y%m%d-%H%M%S"
}

load_environment_variables() {
  eval `./bin/gen_env`
}

backup_file() {
  ts=`timestamp`
  sudo cp $1 $1.backup_$ts
}

script_name() {
  basename "$0"
}

print_header() {
  echo "-------------------------------------------------------------"
  echo "`date` - `script_name`"
}

msg() {
  echo "> $1..."
}

can_ping() {
  ping -c1 $1 > /dev/null 2>&1
}

can_ssh() {
  ssh -q $1 exit
}

local_ip_address() {
  [ -n $network_interface ] || raise "network_interface not defined"
  ifconfig $network_interface | grep 'inet addr' | awk '{print $2}' | sed -s 's/addr://' | grep .
}

remove_blank_lines() {
  echo -e $1 | sed '/^$/d'
}

raise() {
  echo "Error: $1"
  exit 1
}

stop_ondeck_backup() {
  if ps aux | grep -q '[o]ndeck' ; then
    msg "Kill active ondeck backup process"
    sudo kill $(ps aux | grep '[o]ndeck' | awk '{print $2}')
  fi
}

create_ondeck_backup() {
  msg "Start process to create new ondeck backup"
  sudo rm -r $rpi_base/ondeck
  sudo mkdir -p $rpi_base/ondeck
  sudo nohup cp -a $rpi_master_root $rpi_ondeck_root > /dev/null 2>&1 &  
}

load_environment_variables
print_header
