#!/bin/bash

source ./bin/ci/util
load_environment_variables
print_header

# Reload main env
pwd=$(pwd)

if [ ! -d $rpi_master_root ]; then 
  msg "ERROR! $rpi_master_root does not exist! Exiting"
  exit 1
else
  msg "Remove old $rpi_master_root"
  sudo mv $rpi_master_root $rpi_master_root.kill  # rename
  sudo nohup rm -Rf $rpi_base_dir &               # delete in background job
  sync;sync;sync 

  msg "Create new $rpi_master_root"
  sudo mkdir -f $rpi_base
  if [ -d $rpi_ondeck_root ]; then
    sudo mv $rpi_ondeck_root $rpi_active_root    # rename the ondeck_root (fast!)
  else
    sudo cp $rpi_master_root $rpi_active_root    # copy the master_root (slow)
    sync;sync;sync
  fi

  msg "Prepare new ondeck backup"
  sudo mkdir -f $rpi_base/ondeck
  sudo nohup cp -r $rpi_master_root $rpi_ondeck_root &  # create a new ondeck root...
  fi
