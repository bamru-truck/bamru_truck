#!/usr/bin/env ruby

# This script generates environment variables used by RPi continuous
# integration scripts.  The YAML text at the bottom of the script allows
# environment variables to be customized for specific user and hostnames.
#
# Ruby saves all data after the __END__ statement in a string variable DATA. We
# turn the YAML data into a ruby hash, then merge the values together.  
#
# Note that _base values supply defaults that can be over-ridded for a specific
# user or host.
#
# To use this in a shell script: "eval `gen_env`"

require 'yaml'
require 'pp'

hostname = ENV['SYSNAME']      
username = ENV['USER']

raw_data  = YAML::load(DATA)                # DATA has everything after __END__
base = raw_data.fetch("_base", {})          # extract the base values from raw_data
user = raw_data.fetch(username  , {})       # extract the user values from the raw_data
user_base = user.fetch("_base"  , {})       # extract the user_base values
user_host = user.fetch(hostname , {})       # extract the user host-specific values

out_data = [base, user_base, user_host].reduce(&:merge)

puts out_data.map {|key, value| "#{key}=#{value}"}.join("\n")

__END__
---
_base:
  rpi_base_dir: /export/raspbian/working
  rpi_base_tgz: /export/raspbian/basic-image-with-ssh-keys.tar.gz
aleak:
  _base:
    rpi_hostname: cat4
    rpi_ssid: cat4
    switch_tty: /dev/ttyUSB0
    playbook: phase1
mgregg:
  
